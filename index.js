import{initializeApp as e}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getFirestore as t,collection as r,getDocs as a,getDoc as l,doc as o,query as n,orderBy as i,limit as s,startAfter as c,where as d,getCountFromServer as $}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";let firebaseConfig;try{let p=await fetch("./firebase-config.json");if(!p.ok)throw Error("Config Not Found");firebaseConfig=await p.json()}catch(g){firebaseConfig={apiKey:"AIzaSyBCtYBO5ukNw83levVZNf6n68_kmPrJNxc",projectId:"prompt-gallery-64aa9"},console.warn("⚠️ Using Fallback Config")}let app=e(firebaseConfig),db=t(app),allData=[],currentPage=1,itemsPerPage=30,currentCategory="All",searchTerm="",totalDocs=0,pageCursors=[],urlParams=new URLSearchParams(window.location.search),viewId=urlParams.get("id"),isViewPage=!!viewId||window.location.pathname.includes("view.html"),normalizeArr=e=>e?Array.isArray(e)?e:"string"==typeof e&&""!==e.trim()?[e]:[]:[];if(window.copyToClipboard=e=>{e&&navigator.clipboard.writeText(e).then(()=>showToast("COPIED!")).catch(console.error)},window.showToast=e=>{let t=document.getElementById("toast");t||((t=document.createElement("div")).id="toast",t.className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-yellow-400 text-black px-6 py-3 rounded-full font-bold shadow-[0_0_30px_rgba(250,204,21,0.5)] hidden items-center gap-3 z-[9999] transition-all duration-300 transform translate-y-10 opacity-0",t.innerHTML='<i class="fa-solid fa-check-circle text-lg"></i><span class="uppercase tracking-wide text-xs font-mono"></span>',document.body.appendChild(t)),t.querySelector("span").innerText=e,t.classList.remove("hidden"),setTimeout(()=>t.classList.remove("translate-y-10","opacity-0"),10),setTimeout(()=>{t.classList.add("translate-y-10","opacity-0"),setTimeout(()=>t.classList.add("hidden"),300)},2500)},isViewPage){async function u(){let e=document.getElementById("loadingState"),t=document.getElementById("contentArea");if(!viewId){window.location.href="index.html";return}try{let r=await l(o(db,"prompts",viewId));if(!r.exists()){document.body.innerHTML='<div class="h-screen flex items-center justify-center text-white">Prompt Not Found</div>';return}let a={id:r.id,...r.data()};m(a),f(a),h(a.id),e&&e.classList.add("hidden"),t&&t.classList.remove("hidden")}catch(n){console.error(n),e&&(e.innerHTML="Error Loading Data")}}function m(e){document.getElementById("titleText").innerText=e.title||"Untitled",document.getElementById("categoryBadge").innerText=e.category||"General",document.getElementById("noteText").innerText=e.note||"-",document.getElementById("promptText").innerText=e.prompt||"";let t=document.getElementById("dateText");t&&e.created?.seconds&&(t.innerText=new Date(1e3*e.created.seconds).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}));let r=normalizeArr(e.after),a=normalizeArr(e.before),l=[...new Set([...r,...a])],o=document.getElementById("mainImage"),n=document.getElementById("thumbContainer"),i=document.getElementById("downloadBtn");l.length>0?(o&&(o.src=l[0],o.onclick=()=>openLightbox(null)),i&&(i.href=l[0],i.style.display="inline-flex"),n&&(n.innerHTML="",l.forEach((e,t)=>{let r=document.createElement("img");r.src=e,r.className=`w-16 h-16 rounded border border-neutral-800 cursor-pointer object-cover flex-shrink-0 transition ${0===t?"border-yellow-400 opacity-100":"opacity-50 hover:opacity-100"}`,r.onclick=()=>{o&&(o.style.opacity=.5,o.src=e,setTimeout(()=>o.style.opacity=1,150)),i&&(i.href=e),Array.from(n.children).forEach(e=>{e.className=e.className.replace("border-yellow-400 opacity-100","opacity-50")}),r.className=r.className.replace("opacity-50","border-yellow-400 opacity-100")},n.appendChild(r)}))):(o&&(o.parentElement.innerHTML='<div class="w-full aspect-[4/3] bg-[#111] flex items-center justify-center text-neutral-700">Text Only</div>'),i&&(i.style.display="none"))}function f(e){document.title=`${e.title} | Nano Banana`}async function h(e){let t=document.getElementById("relatedGrid");if(t)try{let l=n(r(db,"prompts"),i("created","desc"),s(20)),o=await a(l),c=[];if(o.forEach(t=>{t.id!==e&&c.push({id:t.id,...t.data()})}),c=c.sort(()=>.5-Math.random()).slice(0,4),t.innerHTML="",0===c.length){t.parentElement.style.display="none";return}c.forEach(e=>{let r=normalizeArr(e.after)[0]||normalizeArr(e.before)[0]||"",a=`
                    <a href="view.html?id=${e.id}" class="block bg-[#090909] border border-neutral-900 rounded-xl overflow-hidden group hover:border-yellow-500/50 transition">
                        <div class="h-40 bg-black relative overflow-hidden">
                            ${r?`<img src="${r}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-500">`:""}
                            <div class="absolute top-2 left-2 bg-black/80 text-yellow-400 text-[9px] font-bold px-2 py-0.5 rounded border border-yellow-500/20">${e.category||"Gen"}</div>
                        </div>
                        <div class="p-3">
                            <h4 class="text-white text-sm font-bold truncate group-hover:text-yellow-400 transition">${e.title||"Untitled"}</h4>
                        </div>
                    </a>`;t.innerHTML+=a})}catch(d){console.warn(d)}}u(),window.copyMainPrompt=()=>{window.copyToClipboard(document.getElementById("promptText").innerText)}}else{let b=document.getElementById("grid"),y=document.getElementById("paginationControls"),x=document.getElementById("itemsPerPage"),w=document.getElementById("searchInput"),v=document.querySelectorAll(".tab-btn");async function _(){await E(),C(1)}async function E(){try{let e=r(db,"prompts");"All"!==currentCategory&&(e=n(r(db,"prompts"),d("category","==",currentCategory)));let t=await $(e);totalDocs=t.data().count}catch(a){console.warn("Count Error (Ignore if index missing):",a)}}async function C(e){if(b){if(b.innerHTML=`
            <div class="col-span-full text-center py-32">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-yellow-400 mb-4"></i>
                <p class="text-neutral-500 font-mono text-xs uppercase tracking-[0.2em]">Loading Page ${e}...</p>
            </div>`,searchTerm){await k();return}try{let t=r(db,"prompts"),l=[];"All"!==currentCategory&&l.push(d("category","==",currentCategory)),l.push(i("created","desc")),e>1&&pageCursors[e-1]&&l.push(c(pageCursors[e-1])),l.push(s(itemsPerPage));let o=n(t,...l),$=await a(o);if($.empty){b.innerHTML='<div class="col-span-full text-center py-20 text-neutral-600 font-mono text-sm">NO DATA FOUND</div>',y.classList.add("hidden");return}let p=$.docs[$.docs.length-1];pageCursors[e]=p;let g=[];$.forEach(e=>g.push({id:e.id,...e.data()})),currentPage=e,L(g),P()}catch(u){if(console.error("\uD83D\uDD25 Load Error:",u),"failed-precondition"===u.code||u.message.includes("index")){let m=u.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/),f=m?m[0]:"https://console.firebase.google.com";b.innerHTML=`
                    <div class="col-span-full text-center py-10 bg-red-900/20 border border-red-900/50 rounded-xl p-6">
                        <i class="fa-solid fa-triangle-exclamation text-3xl text-red-500 mb-3"></i>
                        <h3 class="text-white font-bold text-lg mb-2">MISSING INDEX</h3>
                        <p class="text-neutral-400 text-xs mb-4">Firestore requires an index for this query (Category + Sort).</p>
                        <a href="${f}" target="_blank" class="inline-block bg-red-600 hover:bg-red-500 text-white px-6 py-2 rounded-full font-bold text-xs uppercase tracking-wider transition">
                            Create Index Now
                        </a>
                        <p class="text-[10px] text-neutral-500 mt-4">*Click the button, create index, wait 2 mins, then refresh.</p>
                    </div>`}else b.innerHTML=`<div class="col-span-full text-center text-red-500 font-mono py-20">ERROR: ${u.message}</div>`}}}function L(e){b.innerHTML="",e.forEach(e=>{let t=normalizeArr(e.after),r=normalizeArr(e.before),a=t[0]||r[0]||"",l=r.length>0?r:t,o=a?`<img src="${a}" loading="lazy" class="main-img w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100">`:'<div class="w-full h-full bg-[#111] flex items-center justify-center"><i class="fa-solid fa-bolt text-3xl text-neutral-800"></i></div>',n="";l.slice(0,4).forEach(e=>{n+=`<img src="${e}" 
         class="w-6 h-6 rounded-sm border border-neutral-800 hover:border-yellow-400 cursor-pointer object-cover bg-black" 
         onmouseover="this.closest('.card').querySelector('.main-img').src='${e}'"
         onmouseout="this.closest('.card').querySelector('.main-img').src='${a||e}'"
    >`});let i=(e.prompt||"").replace(/"/g,"&quot;").replace(/`/g,"\\`"),s=document.createElement("article");s.className="card bg-[#090909] border border-neutral-900 rounded-xl overflow-hidden group hover:border-yellow-500/50 transition shadow-lg flex flex-col h-full",s.innerHTML=`
                <a href="view.html?id=${e.id}" class="block relative aspect-[4/3] bg-black overflow-hidden cursor-pointer">
                    ${o}
                    <div class="absolute top-2 left-2 bg-black/80 backdrop-blur text-yellow-400 text-[9px] font-bold uppercase px-2 py-0.5 rounded border border-yellow-500/20 shadow-lg">${e.category||"Gen"}</div>
                </a>
                <div class="p-4 flex flex-col flex-1">
                    <div class="flex gap-1 mb-3 h-6 overflow-hidden">${n}</div>
                    <a href="view.html?id=${e.id}" class="block group-hover:text-yellow-400 transition-colors mb-1">
                        <h3 class="font-bold text-white text-sm line-clamp-1" title="${e.title||""}">${e.title||"Untitled"}</h3>
                    </a>
                    <p class="text-neutral-500 text-xs line-clamp-2 mb-3 h-8 leading-relaxed">${e.note||"-"}</p>
                    <div class="mt-auto pt-3 border-t border-neutral-900">
                         <button onclick="window.copyToClipboard(\`${i}\`)" class="w-full bg-neutral-950 text-neutral-400 text-[10px] font-bold py-2.5 rounded border border-neutral-800 hover:bg-yellow-400 hover:text-black hover:border-yellow-400 transition uppercase tracking-wider flex items-center justify-center gap-2">
                            <i class="fa-regular fa-copy"></i> Copy Prompt
                         </button>
                    </div>
                </div>`,b.appendChild(s)})}function P(){y.innerHTML="",y.classList.remove("hidden");let e=Math.ceil(totalDocs/itemsPerPage);if(e<=1){y.classList.add("hidden");return}let t=(e,t,r,a)=>{let l=document.createElement("button");return l.innerHTML=e,l.className=`w-9 h-9 flex items-center justify-center rounded-full text-xs font-bold transition duration-200 select-none
                ${r?"bg-yellow-400 text-black shadow-[0_0_15px_rgba(250,204,21,0.4)] scale-110":"bg-black border border-neutral-800 text-neutral-400 hover:border-yellow-400 hover:text-white"}
                ${a?"opacity-30 cursor-not-allowed hover:border-neutral-800 hover:text-neutral-400":""}`,a||r||(l.onclick=()=>{1===t||t===currentPage+1||pageCursors[t-1]?(C(t),window.scrollTo({top:0,behavior:"smooth"})):showToast("Please navigate sequentially")}),l},r=document.createElement("div");r.className="flex items-center gap-2",r.appendChild(t('<i class="fa-solid fa-chevron-left"></i>',currentPage-1,!1,1===currentPage));let a=Math.max(1,currentPage-2),l=Math.min(e,a+5-1);l-a<4&&(a=Math.max(1,l-5+1)),a>1&&(r.appendChild(t("1",1,!1,!pageCursors[0]&&1!==currentPage&&2!==currentPage)),a>2&&r.appendChild(T()));for(let o=a;o<=l;o++){let n=1===o||o===currentPage+1||!!pageCursors[o-1];r.appendChild(t(o,o,o===currentPage,!n&&o!==currentPage))}l<e&&(l<e-1&&r.appendChild(T()),r.appendChild(t(e,e,!1,!0))),r.appendChild(t('<i class="fa-solid fa-chevron-right"></i>',currentPage+1,!1,currentPage===e)),y.appendChild(r)}function T(){let e=document.createElement("span");return e.className="text-neutral-600 px-1",e.innerText="...",e}async function k(){if(0===allData.length){let e=n(r(db,"prompts"),i("created","desc")),t=await a(e);t.forEach(e=>allData.push({id:e.id,...e.data()}))}let l="All"===currentCategory?allData:allData.filter(e=>e.category===currentCategory),o=searchTerm.toLowerCase();totalDocs=(l=l.filter(e=>(e.title+e.prompt).toLowerCase().includes(o))).length;let s=Math.ceil(totalDocs/itemsPerPage);currentPage>s&&(currentPage=1);let c=(currentPage-1)*itemsPerPage;L(l.slice(c,c+itemsPerPage)),pageCursors=[],P()}_(),v.forEach(e=>e.addEventListener("click",()=>{v.forEach(e=>{e.classList.remove("bg-yellow-400","text-black"),e.classList.add("bg-black","text-neutral-400","border-neutral-800")}),e.classList.remove("bg-black","text-neutral-400","border-neutral-800"),e.classList.add("bg-yellow-400","text-black"),currentCategory=e.dataset.cat,currentPage=1,pageCursors=[],allData=[],_()})),x.addEventListener("change",e=>{itemsPerPage=+e.target.value,currentPage=1,pageCursors=[],C(1)}),w.addEventListener("input",e=>{searchTerm=e.target.value.trim(),currentPage=1,C(1)})}window.openLightbox=e=>{e&&e.preventDefault();let t=document.getElementById("mainImage"),r=document.getElementById("lightbox"),a=document.getElementById("lightboxImg");t&&r&&a&&(a.src=t.src,r.classList.remove("hidden"),r.classList.add("flex"),document.body.style.overflow="hidden")},window.closeLightbox=()=>{let e=document.getElementById("lightbox");e&&(e.classList.add("hidden"),e.classList.remove("flex"),document.body.style.overflow="")};let box=document.getElementById("lightbox");box&&(box.onclick=e=>{e.target===box&&window.closeLightbox()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&window.closeLightbox()});
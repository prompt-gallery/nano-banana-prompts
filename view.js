import{initializeApp as e}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getFirestore as t,collection as l,getDocs as r,getDoc as a,doc as o,query as i,orderBy as n,limit as s,startAfter as c,where as d,getCountFromServer as $}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";let firebaseConfig={apiKey:"AIzaSyBCtYBO5ukNw83levVZNf6n68_kmPrJNxc",projectId:"prompt-gallery-64aa9"},app=e(firebaseConfig),db=t(app),urlParams=new URLSearchParams(window.location.search),viewId=urlParams.get("id"),isViewPage=!!viewId||window.location.pathname.endsWith("view.html")||null!==document.getElementById("mainImage"),normalizeArr=e=>e?Array.isArray(e)?e:"string"==typeof e&&""!==e.trim()?[e]:[]:[];if(window.copyToClipboard=e=>{e&&navigator.clipboard.writeText(e).then(()=>window.showToast("COPIED!")).catch(console.error)},window.showToast=e=>{let t=document.getElementById("toast");t||((t=document.createElement("div")).id="toast",t.className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-yellow-400 text-black px-6 py-3 rounded-full font-bold shadow-[0_0_30px_rgba(250,204,21,0.5)] hidden items-center gap-3 z-[9999] transition-all duration-300 transform translate-y-10 opacity-0",t.innerHTML='<i class="fa-solid fa-check-circle text-lg"></i><span class="uppercase tracking-wide text-xs font-mono"></span>',document.body.appendChild(t)),t.querySelector("span").innerText=e,t.classList.remove("hidden"),setTimeout(()=>t.classList.remove("translate-y-10","opacity-0"),10),setTimeout(()=>{t.classList.add("translate-y-10","opacity-0"),setTimeout(()=>t.classList.add("hidden"),300)},2500)},isViewPage){async function p(){let e=document.getElementById("loadingState"),t=document.getElementById("contentArea");if(!viewId){window.location.href="index.html";return}try{let l=await a(o(db,"prompts",viewId));if(!l.exists()){document.body.innerHTML='<div class="h-screen flex items-center justify-center text-white">PROMPT NOT FOUND</div>';return}let r={id:l.id,...l.data()};f(r),m(r.id),e&&e.classList.add("hidden"),t&&t.classList.remove("hidden")}catch(i){console.error(i),e&&(e.innerHTML="Error Loading Data")}}function f(e){document.getElementById("titleText").innerText=e.title||"Untitled",document.getElementById("categoryBadge").innerText=e.category||"General",document.getElementById("noteText").innerText=e.note||"-",document.getElementById("promptText").innerText=e.prompt||"";let t=document.getElementById("dateText");t&&e.created?.seconds&&(t.innerText=new Date(1e3*e.created.seconds).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}));let l=normalizeArr(e.after),r=normalizeArr(e.before),a=[...new Set([...l,...r])].filter(e=>e&&""!==e.trim()),o=document.getElementById("mainImage"),i=document.getElementById("thumbContainer"),n=document.getElementById("downloadBtn");if(0===a.length){if(o){let s=o.parentElement;s.innerHTML=`
                    <div class="w-full h-full flex flex-col items-center justify-center bg-[#080808] text-neutral-800">
                        <i class="fa-solid fa-bolt text-6xl group-hover:text-yellow-500/50 transition duration-500"></i>
                        <span class="text-[10px] font-mono mt-4 tracking-widest text-neutral-600 uppercase">Text Only Prompt</span>
                    </div>`}i&&(i.innerHTML='<span class="text-[10px] text-neutral-600 font-mono italic p-2">No preview images available</span>'),n&&(n.style.display="none")}else o&&(o.src=a[0],o.style.display="block",o.onclick=()=>window.openLightbox(),o.onerror=function(){this.style.display="none",this.parentElement.innerHTML=`
                        <div class="w-full h-full flex flex-col items-center justify-center bg-[#111]">
                            <i class="fa-solid fa-triangle-exclamation text-4xl text-red-900"></i>
                            <span class="text-[10px] text-neutral-600 mt-2">Image Load Failed</span>
                        </div>`}),n&&(n.href=a[0],n.style.display="inline-flex"),i&&(i.innerHTML="",a.forEach((e,t)=>{let l=document.createElement("img");l.src=e,l.className=`w-16 h-16 rounded border border-neutral-800 cursor-pointer object-cover flex-shrink-0 transition ${0===t?"border-yellow-400 opacity-100":"opacity-50 hover:opacity-100"}`,l.onclick=()=>{o&&(o.style.opacity=.5,o.src=e,setTimeout(()=>o.style.opacity=1,150)),n&&(n.href=e),Array.from(i.children).forEach(e=>{e.className=e.className.replace("border-yellow-400 opacity-100","opacity-50")}),l.className=l.className.replace("opacity-50","border-yellow-400 opacity-100")},i.appendChild(l)}))}async function m(e){let t=document.getElementById("relatedGrid");if(t)try{let a=i(l(db,"prompts"),n("created","desc"),s(20)),o=await r(a),c=[];if(o.forEach(t=>{t.id!==e&&c.push({id:t.id,...t.data()})}),c=c.sort(()=>.5-Math.random()).slice(0,4),t.innerHTML="",0===c.length){t.parentElement.style.display="none";return}c.forEach(e=>{let l=normalizeArr(e.after),r=normalizeArr(e.before),a=l[0]||r[0]||"",o;o=a&&""!==a.trim()?`
                        <img src="${a}" 
                             class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition duration-500" 
                             loading="lazy"
                             onerror="this.onerror=null; this.parentElement.innerHTML='<div class='w-full h-full bg-[#111] flex items-center justify-center'><i class='fa-solid fa-bolt text-2xl text-neutral-800'></i></div>';">
                    `:`
                        <div class="w-full h-full bg-[#111] flex items-center justify-center">
                            <i class="fa-solid fa-bolt text-2xl text-neutral-800 group-hover:text-yellow-500/50 transition"></i>
                        </div>`;let i=`
                    <a href="view.html?id=${e.id}" class="block bg-[#090909] border border-neutral-900 rounded-xl overflow-hidden group hover:border-yellow-500/50 transition shadow-lg h-full flex flex-col">
                        <div class="h-40 bg-black relative overflow-hidden shrink-0">
                            ${o}
                            <div class="absolute top-2 left-2 bg-black/80 text-yellow-400 text-[9px] font-bold px-2 py-0.5 rounded border border-yellow-500/20 shadow-md">
                                ${e.category||"Gen"}
                            </div>
                        </div>
                        <div class="p-3 flex flex-col flex-1">
                            <h4 class="text-white text-sm font-bold truncate group-hover:text-yellow-400 transition mb-1">
                                ${e.title||"Untitled"}
                            </h4>
                            <p class="text-neutral-500 text-[10px] line-clamp-2 font-mono leading-relaxed h-8">
                                ${e.note||"No description."}
                            </p>
                        </div>
                    </a>`;t.innerHTML+=i})}catch(d){console.warn("Related Load Error",d),t.innerHTML='<p class="text-[10px] text-neutral-600 font-mono col-span-full text-center">Failed to load suggestions</p>'}}console.log("\uD83D\uDCC2 Mode: View Page"),window.copyMainPrompt=()=>window.copyToClipboard(document.getElementById("promptText").innerText),window.shareFacebook=()=>window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`,"_blank"),window.shareTwitter=()=>window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(document.title)}&url=${encodeURIComponent(window.location.href)}`,"_blank"),window.shareReddit=()=>window.open(`https://www.reddit.com/submit?title=${encodeURIComponent(document.title)}&url=${encodeURIComponent(window.location.href)}`,"_blank"),window.copyShareLink=()=>{navigator.clipboard.writeText(window.location.href),window.showToast("LINK COPIED")},window.openLightbox=e=>{e&&e.preventDefault();let t=document.getElementById("lightbox"),l=document.getElementById("lightboxImg");t&&l&&(l.src=document.getElementById("mainImage").src,t.classList.remove("hidden"),t.classList.add("flex"))};let h=document.getElementById("lightbox");h&&(h.onclick=e=>{e.target===h&&(h.classList.add("hidden"),h.classList.remove("flex"))}),document.addEventListener("keydown",e=>{"Escape"===e.key&&h&&(h.classList.add("hidden"),h.classList.remove("flex"))}),p()}else{console.log("\uD83D\uDCC2 Mode: Gallery Page");let u=[],x=1,g=30,b="All",y="",w=0,v=[],_=document.getElementById("grid"),L=document.getElementById("paginationControls"),E=document.getElementById("itemsPerPage"),T=document.getElementById("searchInput"),I=document.querySelectorAll(".tab-btn");async function k(){_&&(await B(),M(1))}async function B(){try{let e=l(db,"prompts");"All"!==b&&(e=i(e,d("category","==",b)));let t=await $(e);w=t.data().count}catch(r){console.warn("Count failed (check index)",r)}}async function M(e){if(_.innerHTML=`<div class="col-span-full text-center py-32"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-yellow-400 mb-4"></i><p class="text-neutral-500 font-mono text-xs uppercase tracking-widest">Loading Page ${e}...</p></div>`,y){await H();return}try{let t=l(db,"prompts"),a=[];"All"!==b&&a.push(d("category","==",b)),a.push(n("created","desc")),e>1&&v[e-1]&&a.push(c(v[e-1])),a.push(s(g));let o=await r(i(t,...a));if(o.empty){_.innerHTML='<div class="col-span-full text-center py-20 text-neutral-600 font-mono text-sm">NO DATA FOUND</div>',L&&L.classList.add("hidden");return}let $=o.docs[o.docs.length-1];v[e]=$;let p=[];o.forEach(e=>p.push({id:e.id,...e.data()})),x=e,C(p),N()}catch(f){if(console.error(f),f.message.includes("index")){let m=f.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/)?.[0]||"#";_.innerHTML=`<div class="col-span-full text-center text-red-500 py-10"><a href="${m}" target="_blank" class="bg-red-900 text-white px-4 py-2 rounded">MISSING INDEX - CLICK TO FIX</a></div>`}else _.innerHTML=`<div class="col-span-full text-center text-red-500 py-20">Error: ${f.message}</div>`}}function C(e){_.innerHTML="";let t=(e,t)=>e&&""!==e.trim()?`
                <img src="${e}" loading="lazy" class="${t}" 
                     onerror="this.onerror=null; this.parentElement.innerHTML='<div class='w-full h-full bg-[#111] flex items-center justify-center'><i class='fa-solid fa-bolt text-4xl text-neutral-800'></i></div>';">
            `:`
                    <div class="w-full h-full bg-[#111] flex items-center justify-center border-b border-neutral-900">
                        <i class="fa-solid fa-bolt text-4xl text-neutral-800 group-hover:text-yellow-500/50 transition duration-500"></i>
                    </div>`;e.forEach(e=>{let l=normalizeArr(e.after),r=normalizeArr(e.before),a=l[0]||r[0]||"",o=r.length>0?r:l,i=t(a,"main-img w-full h-full object-cover transition duration-500 group-hover:scale-110 opacity-90 group-hover:opacity-100 bg-neutral-900"),n="";o.slice(0,4).forEach(e=>{e&&""!==e.trim()&&(n+=`<img src="${e}" class="w-6 h-6 rounded-sm border border-neutral-800 hover:border-yellow-400 cursor-pointer object-cover bg-black" onmouseover="const main=this.closest('.card').querySelector('.main-img'); if(main) main.src='${e}'">`)});let s=(e.prompt||"").replace(/"/g,"&quot;").replace(/`/g,"\\`"),c=document.createElement("article");c.className="card bg-[#090909] border border-neutral-900 rounded-xl overflow-hidden group hover:border-yellow-500/50 transition shadow-lg flex flex-col h-full",c.innerHTML=`
                <a href="view.html?id=${e.id}" class="block relative aspect-[4/3] bg-black overflow-hidden cursor-pointer">
                    ${i}
                    <div class="absolute top-2 left-2 bg-black/80 backdrop-blur text-yellow-400 text-[9px] font-bold uppercase px-2 py-0.5 rounded border border-yellow-500/20 shadow-lg">${e.category||"Gen"}</div>
                </a>
                <div class="p-4 flex flex-col flex-1">
                    <div class="flex gap-1 mb-3 h-6 overflow-hidden">${n}</div>
                    <a href="view.html?id=${e.id}" class="block group-hover:text-yellow-400 transition-colors mb-1">
                        <h3 class="font-bold text-white text-sm line-clamp-1" title="${e.title||""}">${e.title||"Untitled"}</h3>
                    </a>
                    <p class="text-neutral-500 text-xs line-clamp-2 mb-3 h-8 leading-relaxed">${e.note||"-"}</p>
                    <div class="mt-auto pt-3 border-t border-neutral-900">
                         <button onclick="window.copyToClipboard(\`${s}\`)" class="w-full bg-neutral-950 text-neutral-400 text-[10px] font-bold py-2.5 rounded border border-neutral-800 hover:bg-yellow-400 hover:text-black hover:border-yellow-400 transition uppercase tracking-wider flex items-center justify-center gap-2">
                            <i class="fa-regular fa-copy"></i> Copy Prompt
                         </button>
                    </div>
                </div>`,_.appendChild(c)})}function N(){if(!L)return;L.innerHTML="";let e=Math.ceil(w/g);if(e<=1){L.classList.add("hidden");return}L.classList.remove("hidden");let t=(e,t,l,r)=>{let a=document.createElement("button");return a.innerHTML=e,a.className=`w-9 h-9 flex items-center justify-center rounded-full text-xs font-bold transition ${l?"bg-yellow-400 text-black shadow-lg scale-110":"bg-black border border-neutral-800 text-neutral-400 hover:text-white"} ${r?"opacity-30 cursor-not-allowed":""}`,r||l||(a.onclick=()=>{M(t),window.scrollTo({top:0,behavior:"smooth"})}),a},l=document.createElement("div");l.className="flex items-center gap-2",l.appendChild(t('<i class="fa-solid fa-chevron-left"></i>',x-1,!1,1===x));let r=Math.max(1,x-2),a=Math.min(e,r+4);a-r<4&&(r=Math.max(1,a-4));for(let o=r;o<=a;o++)l.appendChild(t(o,o,o===x,!1));l.appendChild(t('<i class="fa-solid fa-chevron-right"></i>',x+1,!1,x===e)),L.appendChild(l)}async function H(){if(0===u.length){let e=i(l(db,"prompts"),n("created","desc")),t=await r(e);t.forEach(e=>u.push({id:e.id,...e.data()}))}let a="All"===b?u:u.filter(e=>e.category===b),o=y.toLowerCase();w=(a=a.filter(e=>(e.title+e.prompt).toLowerCase().includes(o))).length;let s=(x-1)*g;C(a.slice(s,s+g)),N()}I&&I.forEach(e=>e.addEventListener("click",()=>{I.forEach(e=>{e.classList.remove("bg-yellow-400","text-black"),e.classList.add("border-neutral-800","text-neutral-400")}),e.classList.remove("border-neutral-800","text-neutral-400"),e.classList.add("bg-yellow-400","text-black"),b=e.dataset.cat,x=1,v=[],k()})),E&&E.addEventListener("change",e=>{g=+e.target.value,x=1,v=[],M(1)}),T&&T.addEventListener("input",e=>{y=e.target.value.trim(),x=1,M(1)}),k()}